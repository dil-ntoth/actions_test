name: 'Protect integration branch'

on:
  workflow_dispatch:
    inputs:
      actionName:
        type: choice
        description: 'Lock or Unlock the branch'
        required: true
        default: 'lock'
        options:
          - 'lock'
          - 'unlock'

jobs:
  lock-the-branch-info:
    runs-on: ubuntu-latest
    steps:
      # - uses: actions/checkout@v3
      #   with:
      #     sparse-checkout: |
      #       .github
      #       src
      # - name: 'Js lock'
      #   run:
      - name: 'Lock / unlock branch'
        run: |
          CODE=`curl -L --write-out '%{http_code}' \
              --silent \
              --output /dev/null \
              --request PUT \
              --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
              --header 'content-type: application/vnd.github+json' \
              --header 'X-GitHub-Api-Version: 2022-11-28' \
              --url 'https://api.github.com/repos/dil-ntoth/actions_test/branches/main/protection' \
              --data '{"lock_branch":true, "enforce_admins":true,"required_pull_request_reviews":null,"required_status_checks":null,"restrictions": null}'`

          if [ $CODE!="200" ]
          then
              echo "FAILURE"
          else
              echo "SUCCESS"
          fi

        env:
          ACTION_NAME: ${{ inputs.actionName }}

# curl -L -X PUT -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" -d '{"lock_branch":true, "enforce_admins":true,"required_pull_request_reviews":null,"required_status_checks":null,"restrictions": null}' https://api.github.com/repos/dil-ntoth/actions_test/branches/main/protection
# if [ "$ACTION_NAME" == "unlock" ]; then curl -L -X DELETE -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/dil-ntoth/actions_test/branches/$GITHUB_REF_NAME/protection ; fi
